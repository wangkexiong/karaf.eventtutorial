## Karaf Installation and Startup

Before Apache Karaf can provide you with an OSGi-based container runtime, we'll have to set up our environment first. The process is quick, requiring a minimum of normal Java usage integration work. Package download and installation can follow the guide from [Apache Karaf Project Site][]. I used 3.0.3 in this tutorial.

After extracting the Apache Karaf distribution kit and setting environment variables, the container can be started by invoking the Karaf script provided in the  bin directory:

* `bin\karaf` in Windows Command Shell
* `bin/karaf` in Linux Shell

You can use ctrl-D to exit the shell. However, Karaf process dies when you exit the shell. To make Karaf running in the background, you can use script named start under bin directory or install Karaf as service. After that, we can use SSH client or script client under bin directory to connect already running Karaf.

The easiest way is to run start script:

* `bin\start` in Windows Command Shell
* `bin/start` in Linux Shell

On Linux, the command shows nothing and run in the background. You can use `ps -ef | grep karaf` to get the JVM process running with Karaf. While for windows, a shell window will appear. Now we can connect to Karaf using SSH client or client provided by Karaf. By default, Karaf opened SSH port 8101 and create user karaf with password karaf.

```bash
$ ssh localhost -p 8101 -l karaf
$ bin/client -h localhost -a 8101 -u karaf
```

When connected, using crtl-D will not quit the Karaf process, but only the connected client. If you want to quit the background process, use `shutdown` command provided by Karaf.

```bash
karaf@root()> shutdown
```

To install Karaf as service, we can use the wrapper feature provided by Karaf. Start Karaf shell and run the following commands:

```bash
karaf@root()> feature:install wrapper
karaf@root()> wrapper:install -s AUTO_START -n KARAF -d Karaf -D "KarafService"
```

On Windows platform:

```bash
bin\KARAF-service install
```

On Linux platform:

```bash
huhhot # ln -s /opt/programming/karaf/bin/KARAF-service /etc/init.d/
huhhot # chkconfig KARAF-service --add
huhhot # chkconfig KARAF-service on
```

Karaf supports both Felix and Equinox framework for OSGI implementation. You can switch the framework inside Karaf.

```bash
karaf@root()> system:framework equinox
Changed OSGi framework to equinox. Karaf needs to be restarted to make the change effective
karaf@root()> system:framework felix
Changed OSGi framework to felix. Karaf needs to be restarted to make the change effective
```

[Apache Karaf Project Site]: http://karaf.apache.org

## Run in the Karaf

First, we do a fresh build and install our bundles in local Maven repository. JDK6 is required to be compatible with Scala 2.8.0.

```bash
$ mvn clean install
```

In Karaf, we add our bundles using Maven repository.

You may notice that when install scala-library 2.8, we use `wrap` type. It is because that release does not include OSGI descriptions. We can use wrap type to deploy no-OSGI jar files("classical" jar files). The exception information here is a bug that does not impact our bundle usage.

However, latest Scala-library are already OSGI bundles. The reason why I use version 2.8.0 is that, it is default generated by skelton and I want to show how to use wrap protocol here. If you don't like it, you can upgrade the Scala version from 2.8.0 to 2.11.7. And remember to remove wrap protocol, because it is already OSGI bundle for 2.11.7.

```bash
        __ __                  ____
       / //_/____ __________ _/ __/
      / ,<  / __ `/ ___/ __ `/ /_
     / /| |/ /_/ / /  / /_/ / __/
    /_/ |_|\__,_/_/   \__,_/_/

  Apache Karaf (3.0.3)

Hit '<tab>' for a list of available commands
and '[cmd] --help' for help on a specific command.
Hit '<ctrl-d>' or type 'system:shutdown' or 'logout' to shutdown Karaf.

karaf@root()> feature:install eventadmin
karaf@root()> bundle:install -s mvn:tk.wangkexiong.osgi/eventconsumer/1.0
Karaf :: Shell eventhandler Commands Started ...
Bundle ID: 65
karaf@root()> bundle:install wrap:mvn:org.scala-lang/scala-library/2.8.0
java.lang.ArrayIndexOutOfBoundsException: 176
        at aQute.bnd.osgi.Clazz.classConstRef(Clazz.java:1862)
        at aQute.bnd.osgi.Clazz.crawl(Clazz.java:1166)
        at aQute.bnd.osgi.Clazz.doCode(Clazz.java:1134)
        at aQute.bnd.osgi.Clazz.doAttribute(Clazz.java:945)
        at aQute.bnd.osgi.Clazz.doAttributes(Clazz.java:910)
        at aQute.bnd.osgi.Clazz.parseClassFile(Clazz.java:741)
        at aQute.bnd.osgi.Clazz.parseClassFile(Clazz.java:494)
        at aQute.bnd.osgi.Clazz.parseClassFileWithCollector(Clazz.java:483)
        at aQute.bnd.osgi.Clazz.parseClassFile(Clazz.java:473)
        at aQute.bnd.osgi.Analyzer.analyzeJar(Analyzer.java:2177)
        at aQute.bnd.osgi.Analyzer.analyzeBundleClasspath(Analyzer.java:2083)
        at aQute.bnd.osgi.Analyzer.analyze(Analyzer.java:138)
        at aQute.bnd.osgi.Analyzer.calcManifest(Analyzer.java:616)
        at org.ops4j.pax.swissbox.bnd.BndUtils.createBundle(BndUtils.java:161)
        at org.ops4j.pax.url.wrap.internal.Connection.getInputStream(Connection.java:83)
        at org.apache.felix.framework.util.SecureAction.getURLConnectionInputStream(SecureAction.java:524)
        at org.apache.felix.framework.cache.JarRevision.initialize(JarRevision.java:165)
        at org.apache.felix.framework.cache.JarRevision.<init>(JarRevision.java:77)
        at org.apache.felix.framework.cache.BundleArchive.createRevisionFromLocation(BundleArchive.java:878)
        at org.apache.felix.framework.cache.BundleArchive.reviseInternal(BundleArchive.java:550)
        at org.apache.felix.framework.cache.BundleArchive.<init>(BundleArchive.java:153)
        at org.apache.felix.framework.cache.BundleCache.create(BundleCache.java:277)
        at org.apache.felix.framework.Felix.installBundle(Felix.java:2866)
        at org.apache.felix.framework.BundleContextImpl.installBundle(BundleContextImpl.java:165)
        at org.apache.karaf.bundle.command.Install.doExecute(Install.java:43)
        at org.apache.karaf.shell.console.AbstractAction.execute(AbstractAction.java:33)
        at org.apache.karaf.shell.console.OsgiCommandSupport.execute(OsgiCommandSupport.java:39)
        at org.apache.karaf.shell.commands.basic.AbstractCommand.execute(AbstractCommand.java:33)
        at Proxy90baf6b3_ea7e_447e_a609_7de43f4600a4.execute(Unknown Source)
        at Proxy90baf6b3_ea7e_447e_a609_7de43f4600a4.execute(Unknown Source)
        at org.apache.felix.gogo.runtime.CommandProxy.execute(CommandProxy.java:78)
        at org.apache.felix.gogo.runtime.Closure.executeCmd(Closure.java:477)
        at org.apache.felix.gogo.runtime.Closure.executeStatement(Closure.java:403)
        at org.apache.felix.gogo.runtime.Pipe.run(Pipe.java:108)
        at org.apache.felix.gogo.runtime.Closure.execute(Closure.java:183)
        at org.apache.felix.gogo.runtime.Closure.execute(Closure.java:120)
        at org.apache.felix.gogo.runtime.CommandSessionImpl.execute(CommandSessionImpl.java:92)
        at org.apache.karaf.shell.console.impl.jline.ConsoleImpl.run(ConsoleImpl.java:208)
        at org.apache.karaf.shell.console.impl.jline.LocalConsoleManager$2$1$1.run(LocalConsoleManager.java:109)
        at java.security.AccessController.doPrivileged(Native Method)
        at org.apache.karaf.jaas.modules.JaasHelper.doAs(JaasHelper.java:57)
        at org.apache.karaf.shell.console.impl.jline.LocalConsoleManager$2$1.run(LocalConsoleManager.java:102)
java.lang.ArrayIndexOutOfBoundsException: 176
        at aQute.bnd.osgi.Clazz.classConstRef(Clazz.java:1862)
        at aQute.bnd.osgi.Clazz.crawl(Clazz.java:1166)
        at aQute.bnd.osgi.Clazz.doCode(Clazz.java:1134)
        at aQute.bnd.osgi.Clazz.doAttribute(Clazz.java:945)
        at aQute.bnd.osgi.Clazz.doAttributes(Clazz.java:910)
        at aQute.bnd.osgi.Clazz.parseClassFile(Clazz.java:741)
        at aQute.bnd.osgi.Clazz.parseClassFile(Clazz.java:494)
        at aQute.bnd.osgi.Clazz.parseClassFileWithCollector(Clazz.java:483)
        at aQute.bnd.osgi.Clazz.parseClassFile(Clazz.java:473)
        at aQute.bnd.osgi.Analyzer.analyzeJar(Analyzer.java:2177)
        at aQute.bnd.osgi.Analyzer.analyzeBundleClasspath(Analyzer.java:2083)
        at aQute.bnd.osgi.Analyzer.analyze(Analyzer.java:138)
        at aQute.bnd.osgi.Analyzer.calcManifest(Analyzer.java:616)
        at org.ops4j.pax.swissbox.bnd.BndUtils.createBundle(BndUtils.java:161)
        at org.ops4j.pax.url.wrap.internal.Connection.getInputStream(Connection.java:83)
        at org.apache.felix.framework.util.SecureAction.getURLConnectionInputStream(SecureAction.java:524)
        at org.apache.felix.framework.cache.JarRevision.initialize(JarRevision.java:165)
        at org.apache.felix.framework.cache.JarRevision.<init>(JarRevision.java:77)
        at org.apache.felix.framework.cache.BundleArchive.createRevisionFromLocation(BundleArchive.java:878)
        at org.apache.felix.framework.cache.BundleArchive.reviseInternal(BundleArchive.java:550)
        at org.apache.felix.framework.cache.BundleArchive.<init>(BundleArchive.java:153)
        at org.apache.felix.framework.cache.BundleCache.create(BundleCache.java:277)
        at org.apache.felix.framework.Felix.installBundle(Felix.java:2866)
        at org.apache.felix.framework.BundleContextImpl.installBundle(BundleContextImpl.java:165)
        at org.apache.karaf.bundle.command.Install.doExecute(Install.java:43)
        at org.apache.karaf.shell.console.AbstractAction.execute(AbstractAction.java:33)
        at org.apache.karaf.shell.console.OsgiCommandSupport.execute(OsgiCommandSupport.java:39)
        at org.apache.karaf.shell.commands.basic.AbstractCommand.execute(AbstractCommand.java:33)
        at Proxy90baf6b3_ea7e_447e_a609_7de43f4600a4.execute(Unknown Source)
        at Proxy90baf6b3_ea7e_447e_a609_7de43f4600a4.execute(Unknown Source)
        at org.apache.felix.gogo.runtime.CommandProxy.execute(CommandProxy.java:78)
        at org.apache.felix.gogo.runtime.Closure.executeCmd(Closure.java:477)
        at org.apache.felix.gogo.runtime.Closure.executeStatement(Closure.java:403)
        at org.apache.felix.gogo.runtime.Pipe.run(Pipe.java:108)
        at org.apache.felix.gogo.runtime.Closure.execute(Closure.java:183)
        at org.apache.felix.gogo.runtime.Closure.execute(Closure.java:120)
        at org.apache.felix.gogo.runtime.CommandSessionImpl.execute(CommandSessionImpl.java:92)
        at org.apache.karaf.shell.console.impl.jline.ConsoleImpl.run(ConsoleImpl.java:208)
        at org.apache.karaf.shell.console.impl.jline.LocalConsoleManager$2$1$1.run(LocalConsoleManager.java:109)
        at java.security.AccessController.doPrivileged(Native Method)
        at org.apache.karaf.jaas.modules.JaasHelper.doAs(JaasHelper.java:57)
        at org.apache.karaf.shell.console.impl.jline.LocalConsoleManager$2$1.run(LocalConsoleManager.java:102)
Bundle ID: 66
karaf@root()> bundle:install -s mvn:tk.wangkexiong.osgi/eventpublisher/1.0
Karaf :: Shell event Commands Started ...
Bundle ID: 67
karaf@root()> eventhandler:list
Registered EventHandler Topics

karaf@root()> eventhandler:add tk/wangkexiong
karaf@root()> event:publish tk/wangkexiong morning!

### Event received ###
tk/wangkexiong
        name->morning!
        event.topics->tk/wangkexiong

karaf@root()> event:publish xxx/yyy morning!
karaf@root()> eventhandler:add xxx/yyy
karaf@root()> event:publish xxx/yyy morning!

### Event received ###
xxx/yyy
        name->morning!
        event.topics->xxx/yyy

```

## KAR package in Production Environment

For those without Internet access, say we are in production environment. There is a KAR package under `eventkar/target`. Just place that package under `$KARAF_HOME/deploy`. The bundles and its dependency will be installed without Internet access. 

